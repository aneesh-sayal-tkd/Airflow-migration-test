name: Trigger Harness Pipeline on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [test, prod]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  trigger-harness-pipeline:
    runs-on: ubuntu-latest
    if: |
      (github.event.pull_request.head.ref == 'dev' && github.event.pull_request.base.ref == 'test') ||
      (github.event.pull_request.head.ref == 'test' && github.event.pull_request.base.ref == 'prod')
    
    steps:
      - name: Determine Migration Type
        id: migration-config
        run: |
          if [[ "${{ github.event.pull_request.head.ref }}" == "dev" && "${{ github.event.pull_request.base.ref }}" == "test" ]]; then
            echo "migration_type=dev-to-test" >> $GITHUB_OUTPUT
            echo "mwaa_env=${{ vars.TEST_MWAA }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.pull_request.head.ref }}" == "test" && "${{ github.event.pull_request.base.ref }}" == "prod" ]]; then
            echo "migration_type=test-to-prod" >> $GITHUB_OUTPUT
            echo "mwaa_env=${{ vars.PROD_MWAA_ENV }}" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Harness Pipeline
        run: |
          echo "ðŸš€ Triggering Harness pipeline for ${{ steps.migration-config.outputs.migration_type }}"
          echo "ðŸ‘¤ Triggered by: ${{ github.actor }}"
          
          curl -X POST "${{ secrets.HARNESS_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "repository": "${{ github.repository }}",
              "pr_number": ${{ github.event.number }},
              "pr_title": "${{ github.event.pull_request.title }}",
              "migration_type": "${{ steps.migration-config.outputs.migration_type }}",
              "mwaa_environment": "${{ steps.migration-config.outputs.mwaa_env }}",
              "triggered_by": "${{ github.actor }}",
              "github_user": "${{ github.actor }}",
              "commit_sha": "${{ github.event.pull_request.head.sha }}",
              "source_branch": "${{ github.event.pull_request.head.ref }}",
              "target_branch": "${{ github.event.pull_request.base.ref }}"
            }'

      - name: Comment on PR
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.number }}/comments \
            -d '{
              "body": "ðŸš€ **Harness Pipeline Triggered**\n\n**Migration:** `${{ steps.migration-config.outputs.migration_type }}`\n**MWAA Environment:** `${{ steps.migration-config.outputs.mwaa_env }}`\n**Triggered by:** @${{ github.actor }}"
            }' \
            --fail-with-body || echo "Comment failed but pipeline triggered"
