name: Trigger Harness Pipeline on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - test
      - prod

# Explicit permissions - this is crucial
permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read
  checks: read

jobs:
  trigger-harness-pipeline:
    runs-on: ubuntu-latest
    if: |
      (github.event.pull_request.head.ref == 'dev' && github.event.pull_request.base.ref == 'test') ||
      (github.event.pull_request.head.ref == 'test' && github.event.pull_request.base.ref == 'prod')
    
    steps:
      - name: Determine Migration Type
        id: migration-type
        run: |
          if [[ "${{ github.event.pull_request.head.ref }}" == "dev" && "${{ github.event.pull_request.base.ref }}" == "test" ]]; then
            echo "source_env=dev" >> $GITHUB_OUTPUT
            echo "target_env=test" >> $GITHUB_OUTPUT
            echo "migration_type=dev-to-test" >> $GITHUB_OUTPUT
            echo "mwaa_env=${{ vars.test_mwaa }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.pull_request.head.ref }}" == "test" && "${{ github.event.pull_request.base.ref }}" == "prod" ]]; then
            echo "source_env=test" >> $GITHUB_OUTPUT
            echo "target_env=prod" >> $GITHUB_OUTPUT
            echo "migration_type=test-to-prod" >> $GITHUB_OUTPUT
            echo "mwaa_env=${{ vars.PROD_MWAA_ENV }}" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Harness Pipeline
        run: |
          curl -X POST "${{ secrets.HARNESS_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "application": "${{ github.repository }}",
              "branch": "${{ github.event.pull_request.head.ref }}",
              "target_branch": "${{ github.event.pull_request.base.ref }}",
              "pr_number": "${{ github.event.number }}",
              "pr_title": "${{ github.event.pull_request.title }}",
              "migration_type": "${{ steps.migration-type.outputs.migration_type }}",
              "source_environment": "${{ steps.migration-type.outputs.source_env }}",
              "target_environment": "${{ steps.migration-type.outputs.target_env }}",
              "mwaa_environment": "${{ steps.migration-type.outputs.mwaa_env }}",
              "triggered_by": "${{ github.actor }}",
              "commit_sha": "${{ github.event.pull_request.head.sha }}",
              "repository_url": "${{ github.event.repository.html_url }}"
            }'

**Details:**
- Source Environment: \`${{ steps.migration-type.outputs.source_env }}\`
- Target Environment: \`${{ steps.migration-type.outputs.target_env }}\`
- MWAA Environment: \`${{ steps.migration-type.outputs.mwaa_env }}\`
- Migration Type: \`${{ steps.migration-type.outputs.migration_type }}\`

Pipeline triggered by: @${{ github.actor }}`
              });
              console.log('✅ Comment posted successfully');
            } catch (error) {
              console.error('❌ Failed to post comment:', error.message);
              // Don't fail the entire workflow if comment fails
            }
